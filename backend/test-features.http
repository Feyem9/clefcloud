### ========================================
### Tests des nouvelles fonctionnalit√©s ClefCloud
### ========================================
### 
### üìã GUIDE D'UTILISATION:
### 1. Assurez-vous que le serveur est d√©marr√©: npm run start:dev
### 2. Ex√©cutez les requ√™tes dans l'ordre (0 ‚Üí 0.2 ‚Üí 1 ‚Üí 2...)
### 3. Les tokens sont extraits automatiquement avec REST Client
### 4. Si l'extraction ne fonctionne pas, copiez manuellement le token
###
### ‚ö†Ô∏è PR√âREQUIS:
### - Extension REST Client install√©e dans VS Code
### - USER_PASSWORD_AUTH activ√© dans AWS Cognito
### - Serveur backend d√©marr√© sur http://localhost:3000
###
### üîë WORKFLOW RAPIDE:
### 1. Ex√©cutez "0. Inscription" (si nouvel utilisateur)
### 2. Ex√©cutez "0.2. Confirmation admin" (DEV ONLY)
### 3. Ex√©cutez "1. Connexion" ‚Üí Les tokens sont extraits automatiquement
### 4. Testez les autres endpoints avec le token
###
### ========================================

@baseUrl = http://localhost:3000/api
@token = YOUR_JWT_TOKEN_HERE
@email = testuser@example.com
@password = NewPassword123!
@phone = +237683845543

### ========================================
### AUTHENTIFICATION
### ========================================

### 0. Inscription (√† faire en premier si l'utilisateur n'existe pas)
# @name signup
POST {{baseUrl}}/auth/signup
Content-Type: application/json

{
  "email": "{{email}}",
  "password": "{{password}}",
  "phone": "{{phone}}"
}

### 0.1. Confirmer l'inscription (code re√ßu par email)
POST {{baseUrl}}/auth/confirm-signup
Content-Type: application/json

{
  "email": "{{email}}",
  "code": "REMPLACER_PAR_CODE_EMAIL"
}

### 0.2. OU Confirmer l'inscription SANS code (DEV ONLY - n√©cessite credentials AWS admin)
POST {{baseUrl}}/auth/admin-confirm-signup
Content-Type: application/json

{
  "email": "{{email}}"
}

### 1. Connexion pour obtenir un token
# @name signin
POST {{baseUrl}}/auth/signin
Content-Type: application/json

{
  "email": "{{email}}",
  "password": "{{password}}"
}

### Extraire le token (automatique avec REST Client)
# IMPORTANT: Apr√®s avoir ex√©cut√© la requ√™te signin ci-dessus, 
# ces variables seront automatiquement remplies
@token = {{signin.response.body.tokens.accessToken}}
@refreshToken = {{signin.response.body.tokens.refreshToken}}

### OU copiez manuellement le token ici si l'extraction automatique ne fonctionne pas
# @token = COLLEZ_VOTRE_ACCESS_TOKEN_ICI

### 2. V√©rifier le profil (route prot√©g√©e)
GET {{baseUrl}}/auth/me
Authorization: Bearer {{token}}

### 2.1. Rafra√Æchir le token
POST {{baseUrl}}/auth/refresh-token
Content-Type: application/json

{
  "refreshToken": "{{refreshToken}}",
  "email": "{{email}}"
}

### 2.2. Renvoyer le code de confirmation
POST {{baseUrl}}/auth/resend-confirmation-code
Content-Type: application/json

{
  "email": "{{email}}"
}

### 2.3. Changer le mot de passe
POST {{baseUrl}}/auth/change-password
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "oldPassword": "Password123!",
  "newPassword": "NewPassword123!"
}

### 2.4. D√©connexion
POST {{baseUrl}}/auth/signout
Authorization: Bearer {{token}}

### 2.5. Supprimer le compte
DELETE {{baseUrl}}/auth/account
Authorization: Bearer {{token}}

### ========================================
### PARTITIONS
### ========================================

### 3. Liste de toutes les partitions
GET {{baseUrl}}/partitions?limit=10&offset=0

### 4. Recherche de partitions
GET {{baseUrl}}/partitions?search=Ave&category=messe

### 5. D√©tails d'une partition
GET {{baseUrl}}/partitions/1

### 6. Upload d'une partition (n√©cessite un fichier)
POST {{baseUrl}}/partitions/upload
Authorization: Bearer {{token}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary

------WebKitFormBoundary
Content-Disposition: form-data; name="title"

Ave Maria
------WebKitFormBoundary
Content-Disposition: form-data; name="composer"

Schubert
------WebKitFormBoundary
Content-Disposition: form-data; name="category"

messe
------WebKitFormBoundary
Content-Disposition: form-data; name="file"; filename="partition.pdf"
Content-Type: application/pdf

< ./test-files/partition.pdf
------WebKitFormBoundary--

### 7. Obtenir l'URL de t√©l√©chargement
GET {{baseUrl}}/partitions/1/download

### 8. Supprimer une partition
DELETE {{baseUrl}}/partitions/1
Authorization: Bearer {{token}}

### ========================================
### FAVORIS
### ========================================

### 9. Ajouter une partition aux favoris
POST {{baseUrl}}/partitions/1/favorite
Authorization: Bearer {{token}}

### 10. Liste des favoris de l'utilisateur
GET {{baseUrl}}/partitions/favorites/list?limit=20&offset=0
Authorization: Bearer {{token}}

### 11. Retirer une partition des favoris
DELETE {{baseUrl}}/partitions/1/favorite
Authorization: Bearer {{token}}

### ========================================
### STATISTIQUES
### ========================================

### 12. Statistiques de l'utilisateur connect√©
GET {{baseUrl}}/partitions/stats/user
Authorization: Bearer {{token}}

### 13. Partitions les plus populaires (public)
GET {{baseUrl}}/partitions/stats/popular?limit=10

### 14. Top 5 des partitions populaires
GET {{baseUrl}}/partitions/stats/popular?limit=5

### ========================================
### UTILISATEURS
### ========================================

### 15. Profil utilisateur
GET {{baseUrl}}/users/1

### 16. Partitions d'un utilisateur
GET {{baseUrl}}/users/1/partitions?limit=10&offset=0

### 17. Mettre √† jour le profil
PATCH {{baseUrl}}/users/1
Authorization: Bearer {{token}}
Content-Type: application/json

{
  "name": "John Doe"
}

### ========================================
### TESTS DE S√âCURIT√â
### ========================================

### 18. Acc√®s √† une route prot√©g√©e sans token (devrait retourner 401)
GET {{baseUrl}}/partitions/stats/user

### 19. Tentative de suppression d'une partition d'un autre utilisateur (devrait retourner 403)
DELETE {{baseUrl}}/partitions/999
Authorization: Bearer {{token}}

### 20. Ajouter deux fois la m√™me partition aux favoris (devrait retourner 409)
POST {{baseUrl}}/partitions/1/favorite
Authorization: Bearer {{token}}

### ========================================
### HEALTH CHECK
### ========================================

### 21. V√©rifier l'√©tat de l'API
GET {{baseUrl}}/health

### 22. Test d'envoi d'email
GET {{baseUrl}}/health/test-email
